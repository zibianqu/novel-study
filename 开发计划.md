# NovelForge AI 开发计划任务

## 项目概述

NovelForge AI 是一个基于 Golang + Eino + 多 Agent 协作的智能小说创作平台。

### 核心技术栈

| 技术领域 | 技术选型 |
|---------|----------|
| 后端框架 | Golang + Gin |
| AI 引擎 | Eino (OpenAI GPT-4o/GPT-3.5) |
| 数据库 | PostgreSQL + pgvector |
| 图数据库 | Neo4j |
| 前端框架 | HTML/JS/CSS + Layui |
| 编辑器 | Monaco Editor |
| 部署方案 | Docker Compose |

---

## 开发时间表（10-12周）

### Week 1-2：基础功能开发
**目标**：搭建基础项目结构和核心 CRUD 功能

**任务清单**：
- [ ] 项目初始化和目录结构搭建
- [ ] 数据库设计和迁移脚本
- [ ] 用户认证系统（JWT）
- [ ] 项目管理 CRUD API
- [ ] 章节管理 CRUD API
- [ ] 前端 Layui 框架集成
- [ ] Monaco Editor 编辑器集成
- [ ] 基础界面开发

---

### Week 3-5：AI Agent 系统开发
**目标**：实现 8 个核心 Agent 及协作机制

**8 个核心 Agent**：

#### Agent 0：总导演（Chief Director）
- **职责**：全局调度、任务分配、质量把控
- **模型**：GPT-4o (temperature: 0.5)
- **工具**：dispatch_agent, query_neo4j, rag_search, get_project_status

#### Agent 1：叙事线掌控（Narrator）
- **职责**：天线、地线、情节线的规划与推进
- **模型**：GPT-4o (temperature: 0.8)
- **知识库**：narrator_knowledge

#### Agent 2：人物塑造（Character Master）
- **职责**：角色性格、成长弧、对话风格
- **模型**：GPT-4o (temperature: 0.9)
- **知识库**：character_knowledge

#### Agent 3：质检官（Quality Inspector）
- **职责**：内容质量评分（一致性、叙事、情节、人物）
- **模型**：GPT-4o (temperature: 0.3)
- **评分维度**：
  - 一致性 (30%)
  - 叙事质量 (25%)
  - 情节合理性 (25%)
  - 人物刻画 (20%)

#### Agent 4-6：世界观构建
- **Agent 4**：世界事件与势力
- **Agent 5**：人物成长与关系
- **Agent 6**：伏笔与线索

**任务清单**：
- [ ] Agent 基础架构设计
- [ ] Eino SDK 集成
- [ ] Agent 0 总导演开发
- [ ] Agent 1 叙事线掌控开发
- [ ] Agent 2 人物塑造开发
- [ ] Agent 3 质检官开发
- [ ] Agent 4-6 世界观构建开发
- [ ] Agent 间通信协议设计
- [ ] SSE 实时推送功能
- [ ] Agent 调度系统
- [ ] Agent 测试接口

---

### Week 6-7：知识库与图谱系统
**目标**：实现 RAG 检索和 Neo4j 知识图谱

**Neo4j 图谱节点**：
- Character（角色）
- Organization（组织）
- Location（地点）
- Event（事件）
- WorldEvent（世界事件）
- PlotArc（情节弧）
- Foreshadow（伏笔）

**关系类型**：
- Character-[GROWS_TO]->CharacterState
- Character-[LEARNS]->Ability
- Character-[RELATIONSHIP_CHANGE]->Character
- WorldEvent-[CAUSES]->WorldEvent
- WorldEvent-[IMPACTS]->Character
- Force-[ALLIANCE/CONFLICT]->Force

**任务清单**：
- [ ] Neo4j 数据库部署
- [ ] 图谱数据模型设计
- [ ] Cypher 查询封装
- [ ] PostgreSQL pgvector 扩展安装
- [ ] 文本嵌入生成（OpenAI Embeddings）
- [ ] RAG 检索系统开发
- [ ] 知识库管理 API
- [ ] 知识导入导出功能
- [ ] AI 自动生成知识库
- [ ] 向量检索优化

---

### Week 8-9：前端界面优化
**目标**：完善用户体验和交互设计

**页面列表**：
- `/login` - 登录页
- `/register` - 注册页
- `/dashboard` - 项目仪表盘
- `/editor/:projectId` - 章节编辑器
- `/director/:projectId` - AI 总导演
- `/characters/:projectId` - 角色管理
- `/worldview/:projectId` - 世界观设定
- `/outline/:projectId` - 大纲管理
- `/storylines/:projectId` - 三线管理
- `/agents` - Agent 管理
- `/workflows` - 工作流编排
- `/knowledge` - 知识库
- `/settings` - 个人设置

**任务清单**：
- [ ] 响应式布局优化
- [ ] Monaco Editor 高级功能（代码补全、语法高亮）
- [ ] 实时协作功能（章节锁定）
- [ ] 版本历史可视化
- [ ] 知识图谱可视化（vis.js）
- [ ] AI 对话界面优化
- [ ] 工作流可视化编排
- [ ] 导出功能（TXT/DOCX/PDF）
- [ ] 移动端适配

---

### Week 10-12：测试与部署
**目标**：系统集成测试和生产环境部署

**任务清单**：
- [ ] 单元测试编写
- [ ] 集成测试
- [ ] API 性能测试
- [ ] 数据库索引优化
- [ ] Token 消耗优化策略
- [ ] Docker 镜像构建
- [ ] docker-compose.yml 配置
- [ ] 环境变量配置
- [ ] 数据库备份策略
- [ ] 日志监控系统
- [ ] 错误追踪（Sentry）
- [ ] 生产环境部署
- [ ] 用户文档编写

---

## API 接口规划

### 1. 项目管理 API

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/api/projects` | 获取项目列表 |
| POST | `/api/projects` | 创建新项目 |
| GET | `/api/projects/:id` | 获取项目详情 |
| PUT | `/api/projects/:id` | 更新项目 |
| DELETE | `/api/projects/:id` | 删除项目 |
| POST | `/api/projects/:id/export` | 导出项目（TXT） |

### 2. 章节管理 API

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/api/chapters/project/:projectId` | 获取章节列表 |
| POST | `/api/chapters` | 创建章节 |
| GET | `/api/chapters/:id` | 获取章节内容 |
| PUT | `/api/chapters/:id` | 更新章节 |
| GET | `/api/chapters/:id/versions` | 获取版本历史 |
| POST | `/api/chapters/:id/rollback` | 回滚到指定版本 |
| POST | `/api/chapters/:id/lock` | 锁定章节 |
| POST | `/api/chapters/:id/unlock` | 解锁章节 |

### 3. Agent API

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/api/agents` | 获取 Agent 列表 |
| POST | `/api/agents` | 创建自定义 Agent |
| PUT | `/api/agents/:id` | 更新 Agent |
| DELETE | `/api/agents/:id` | 删除 Agent |
| POST | `/api/agents/:id/test` | 测试 Agent |

### 4. 工作流 API

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/api/workflows` | 获取工作流列表 |
| POST | `/api/workflows` | 创建工作流 |
| GET | `/api/workflows/:id` | 获取工作流详情 |
| PUT | `/api/workflows/:id` | 更新工作流 |
| DELETE | `/api/workflows/:id` | 删除工作流 |
| POST | `/api/workflows/:id/execute` | 执行工作流（SSE） |
| GET | `/api/workflows/executions/:id` | 获取执行状态 |
| POST | `/api/workflows/executions/:id/pause` | 暂停执行 |
| POST | `/api/workflows/executions/:id/resume` | 恢复执行 |

### 5. AI 功能 API

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | `/api/ai/chat` | AI 对话（SSE） |
| POST | `/api/ai/forecast` | 情节预测 |
| POST | `/api/ai/continue` | 续写（SSE） |
| POST | `/api/ai/polish` | 润色（SSE） |
| POST | `/api/ai/rewrite` | 改写（SSE） |
| POST | `/api/ai/dialogue` | 对话生成（SSE） |
| POST | `/api/ai/consistency-check` | 一致性检查 |
| POST | `/api/ai/character/generate` | AI 生成角色 |
| POST | `/api/ai/outline/generate` | AI 生成大纲 |

### 6. 知识库 API

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/api/knowledge/categories` | 获取分类 |
| POST | `/api/knowledge/categories` | 创建分类 |
| PUT | `/api/knowledge/categories/:id` | 更新分类 |
| DELETE | `/api/knowledge/categories/:id` | 删除分类 |
| GET | `/api/knowledge/items` | 获取知识条目 |
| POST | `/api/knowledge/items` | 创建知识条目 |
| PUT | `/api/knowledge/items/:id` | 更新知识条目 |
| DELETE | `/api/knowledge/items/:id` | 删除知识条目 |
| POST | `/api/knowledge/import` | 批量导入 |
| POST | `/api/knowledge/ai-generate` | AI 生成知识 |
| POST | `/api/knowledge/search` | 知识检索 |

---

## 数据库设计要点

### PostgreSQL 核心表

**用户与项目**：
- `users` - 用户表
- `projects` - 项目表
- `project_collaborators` - 协作者
- `volumes` - 卷/部
- `chapters` - 章节表
- `chapter_versions` - 版本历史

**角色与世界观**：
- `characters` - 角色表
- `world_settings` - 世界观设定
- `outlines` - 大纲表

**向量检索**：
- `content_embeddings` - 内容嵌入（vector(1536)）

**三线系统**：
- `storylines` - 三线表（天线/地线/情节线）
- `storyline_convergences` - 线索交汇点

**Agent 与日志**：
- `agents` - Agent 配置表
- `ai_interaction_logs` - AI 交互日志

---

## 工作流系统

### 工作流节点类型

- `input` - 输入节点
- `output` - 输出节点
- `agent` - Agent 调用
- `condition` - 条件判断
- `loop` - 循环节点
- `rag_search` - RAG 检索
- `neo4j_query` - Neo4j 查询
- `storage` - 数据存储
- `user_confirm` - 用户确认
- `processor` - 数据处理
- `parallel` - 并行执行

### 典型工作流场景

**场景 1：章节生成流程**
```
输入(大纲) → Agent0(总导演) → Agent1(叙事) → Agent2(人物) → Agent3(质检)
  ↓ (score < 75)
  └→ 返回修改 → Agent1 重新生成
```

**场景 2：多 Agent 协作**
```
Agent0(调度) → [并行]
                ├→ Agent4(世界事件)
                ├→ Agent5(人物成长)
                └→ Agent6(伏笔)
              → [汇总] → Neo4j 存储
```

---

## Token 消耗优化策略

### Prompt 优化

1. **System Prompt 压缩**：核心 Agent 控制在 500 tokens 以内
2. **上下文精选**：使用 RAG 检索最相关的 1000 tokens
3. **历史对话裁剪**：保留最近 3 轮对话，压缩至 2000 tokens
4. **知识图谱查询**：Neo4j 查询结果限制 500 tokens
5. **输出长度控制**：单次生成控制在 300 tokens
6. **缓存策略**：相似查询使用缓存结果
7. **模型选择**：非关键任务使用 GPT-3.5
8. **批量处理**：合并多个小任务为一次调用

### 成本预估

| Agent | 模型 | 单次输入 | 单次输出 | 预估成本/次 |
|-------|------|----------|----------|-------------|
| Agent 0 | GPT-4o | 2000 | 300 | $0.03 |
| Agent 1 | GPT-4o | 3000 | 800 | $0.06 |
| Agent 2 | GPT-4o | 2500 | 600 | $0.05 |
| Agent 3 | GPT-4o | 2000 | 200 | $0.03 |

---

## 部署配置

### Docker Compose 服务

```yaml
services:
  app:         # 后端服务 (Golang)
  postgres:    # PostgreSQL + pgvector
  neo4j:       # Neo4j 图数据库
```

### 环境变量配置

```env
DB_PASSWORD=your_secure_db_password
NEO4J_PASSWORD=your_secure_neo4j_password
JWT_SECRET=your_jwt_secret_key
OPENAI_API_KEY=sk-your-openai-key
```

---

## 开发优先级建议

### P0（最高优先级）
- [ ] 用户认证和项目管理
- [ ] 章节编辑器（Monaco Editor）
- [ ] Agent 0（总导演）+ Agent 1（叙事）
- [ ] 基础数据库设计

### P1（高优先级）
- [ ] Agent 2（人物）+ Agent 3（质检）
- [ ] RAG 检索系统
- [ ] Neo4j 知识图谱基础
- [ ] SSE 实时推送

### P2（中优先级）
- [ ] Agent 4-6（世界观构建）
- [ ] 工作流系统
- [ ] 版本历史管理
- [ ] 知识图谱可视化

### P3（低优先级）
- [ ] 导出功能
- [ ] 移动端适配
- [ ] 高级工作流节点
- [ ] 性能优化

---

## 技术难点与解决方案

### 1. Agent 协作一致性
**问题**：多 Agent 生成内容可能出现矛盾  
**方案**：
- Agent 3 质检官实时检测
- Neo4j 图谱约束验证
- 版本回滚机制

### 2. Token 消耗控制
**问题**：大规模使用 GPT-4 成本高  
**方案**：
- RAG 减少上下文长度
- 智能缓存相似请求
- 非关键任务降级到 GPT-3.5

### 3. 实时编辑冲突
**问题**：多用户同时编辑同一章节  
**方案**：
- 章节锁定机制
- Operational Transform 算法
- 版本合并工具

### 4. 知识图谱规模
**问题**：长篇小说图谱节点数量庞大  
**方案**：
- 分层存储（核心/详细）
- 懒加载和分页查询
- 定期归档历史数据

---

## 项目里程碑

- **M1 (Week 2)**：基础功能可用，能创建项目和编辑章节
- **M2 (Week 5)**：AI Agent 基础功能完成，能进行简单的 AI 续写
- **M3 (Week 7)**：知识图谱和 RAG 系统上线，AI 具备上下文理解
- **M4 (Week 9)**：前端体验完善，功能基本完整
- **M5 (Week 12)**：生产环境部署，对外发布

---

**文档版本**：v1.0  
**更新时间**：2026-02-07  
**负责人**：开发团队  
**项目仓库**：novel-study
